# 网关管理系统需求与用户故事

## 概述

本系统采用 React + Next.js + MUI 构建，是一个功能完整的网关管理系统，支持网关配置、监控、安全防护、运维管理等全生命周期管理。所有页面采用多Tab分区，提升交互体验，避免滚动。

---

## 功能需求

### 1. 网关配置管理

#### 1.1 Gateway配置搜索页面
- 快速搜索和查看所有Gateway配置
- 支持按关键字搜索（域名、路径、应用名称、标签等）
- 支持按状态（生效/未生效/草稿）、应用名称等条件筛选
- 搜索结果包含：生效网址、应用名称、状态、后端服务器、修改者、修改时间
- 每个配置项支持查看、编辑、删除操作（根据用户权限）
- 点击查看/编辑按钮跳转到对应的详情/编辑页面
- 支持刷新数据、删除确认对话框
- 空状态提示和加载状态显示

#### 1.2 Gateway配置查看页面
- 以只读方式展示Gateway配置的详细信息
- 采用标签页形式展示不同类别的配置信息
- 基本信息标签页：显示域名、路径、应用、状态、标签等
- 后端服务器标签页：显示所有后端服务器的详细信息
- 请求头标签页：显示所有请求头配置
- Cookies标签页：显示所有Cookie配置
- 限制器标签页：显示所有访问限制配置
- 历史记录标签页：显示创建和修改历史
- 页面顶部显示编辑和删除按钮（根据权限）
- 支持返回搜索页面的导航

#### 1.3 Gateway配置编辑页面
- 基于现有配置进行修改
- 复用现有的Tab组件和表单验证
- 页面加载时自动填充现有配置数据
- 支持所有Tab的编辑功能（Basic、Backends、Headers、Cookies、Limiters等）
- 检测配置变更，显示未保存更改提示
- 保存时验证所有必填字段和格式
- 支持取消编辑，有未保存更改时显示确认对话框
- 保存成功后跳转到查看页面

#### 1.4 新建网关映射配置页面
页面采用Tab分区，包含如下配置区域：

##### 1.4.1 基本信息（Basic）
- 域名（Domain）
- 请求路径Pattern（Request Path Pattern）
- 后端转发路径（Backend Forward Path）
- 域名+路径Pattern唯一性校验
- CMDB项目下拉选择，数据来源于API，仅显示有权限的项目

##### 1.4.2 后端目标服务器（Targets）
- 支持添加多个目标服务器
- 每个目标服务器需填写：hostname、port、protocol、proxy（可选）、region、data center
- 负载均衡算法选择（轮询、权重、最少连接、IP哈希）
- 健康检查配置（检查路径、间隔、超时、失败阈值）
- **新增：DNS检测功能**
  - 自动检测hostname的DNS解析状态
  - 手动DNS检测按钮，支持IPv4和IPv6解析
  - DNS检测结果显示和详情查看
  - 连接测试功能，测试到后端服务器的TCP连接
  - 连接测试结果显示和响应时间统计

##### 1.4.3 Cookie转发策略（Cookies）
- 策略选项：passthrough、persist
- 可为部分cookie name设置相反策略，支持完全匹配/部分匹配
- 输入需符合RFC标准

##### 1.4.4 Header配置（Headers）
- 支持添加多个Request Header和Response Header
- 每个Header需填写：Name、Value、Override（是否覆盖）
- **新增：CSP配置功能**
  - CSP预设模板选择（Strict、Basic、Custom）
  - 自定义CSP规则编辑器
  - CSP指令和值的智能提示
  - CSP规则预览功能
  - 自动添加Content-Security-Policy响应头

##### 1.4.5 错误页装饰（Response Body Decorator）
- 针对特定错误状态码配置目标页面路径（绝对或相对）

##### 1.4.6 访问限制（Limiters）
- 允许/拒绝模式（Allow/Deny），可动态添加多个IP或子网（IPv4/CIDR格式校验）
- 配置最大允许并发量和每分钟调用数（需至少有一项限制）
- 配置服务允许的请求方法（如GET/POST/PUT/DELETE等）

#### 1.5 配置版本管理
- 配置变更历史记录和版本对比
- 一键回滚到历史版本
- 配置模板管理和批量操作
- 配置导入导出（JSON/YAML格式）

### 2. 监控与可观测性

#### 2.1 实时监控仪表板
- 实时流量监控（QPS、带宽、连接数）
- 响应时间统计（平均、P50、P95、P99）
- 错误率监控（4xx、5xx错误统计）
- 后端服务健康状态监控
- 自定义时间范围查询和图表展示

#### 2.2 告警与通知系统
- 监控阈值配置（响应时间、错误率、流量等）
- 多种通知方式（邮件、短信、Webhook、钉钉、企业微信）
- 告警级别分类和升级策略
- 告警历史记录和确认机制

#### 2.3 日志管理与分析
- 完整的请求/响应日志记录
- 结构化日志搜索和过滤
- 异常请求自动标记
- 日志导出和归档

### 3. 安全与防护

#### 3.1 WAF（Web应用防火墙）
- SQL注入、XSS攻击检测规则
- 自定义安全规则编写
- 攻击IP自动封禁和黑名单管理
- 安全事件统计和报告

#### 3.2 API限流与熔断
- 基于用户、IP、API路径的细粒度限流
- 熔断器配置（错误率阈值、恢复时间、半开状态）
- 限流策略可视化配置
- 限流效果实时监控

#### 3.3 认证与授权
- JWT Token验证配置
- OAuth2.0集成
- API Key管理和轮换
- 用户会话管理和单点登录

### 4. 性能优化

#### 4.1 缓存策略
- HTTP缓存头配置
- 缓存规则设置（按路径、参数、Header）
- 缓存失效策略和预加载
- 缓存命中率统计和优化建议

#### 4.2 连接优化
- 请求压缩配置（Gzip、Brotli）
- 静态资源CDN配置
- 连接池管理和优化
- Keep-Alive配置

### 5. 运维管理

#### 5.1 运维工具集
- 配置热重载和灰度发布
- 服务重启/停止/扩容
- 性能指标收集和基准测试
- 系统资源监控（CPU、内存、磁盘、网络）

#### 5.2 问题诊断
- 请求链路追踪（分布式追踪）
- 性能瓶颈分析和优化建议
- 错误根因分析和自动修复
- 诊断报告生成和分享

### 6. 多租户与团队协作

#### 6.1 多租户管理
- 租户隔离和资源配额管理
- 租户间配置共享和模板
- 计费和用量统计
- 租户管理员权限控制

#### 6.2 团队协作
- 用户角色和权限管理（超级管理员、租户管理员、开发者、运维、只读）
- 操作审计日志和合规报告
- 团队通知和协作工具
- 知识库和文档管理

---

## 用户故事（User Stories）

### 配置管理用户故事

#### US-1: 基本信息配置
- 作为管理员，我希望能填写域名、请求路径Pattern和后端转发路径，并确保域名+路径唯一。
- 作为管理员，我希望有一个下拉列表能显示我有权限的对应CMDB项目名列表方便我匹配当前数据到我的项目。

#### US-2: 目标服务器管理
- 作为管理员，我希望能为每条映射添加多个后端目标服务器，并填写其详细信息。
- 作为管理员，我希望能随时添加或删除目标服务器。
- 作为管理员，我希望配置负载均衡算法和健康检查策略。

#### US-3: Cookie转发策略
- 作为管理员，我希望能选择全局cookie转发策略，并为部分cookie name设置例外。
- 作为管理员，我希望输入cookie name时能获得格式校验提示。

#### US-4: Header配置
- 作为管理员，我希望能为请求和响应分别添加多个Header，并设置是否覆盖。
- 作为管理员，我希望能随时添加或删除Header项。

#### US-5: 错误页装饰（Response Body Decorator）
- 作为管理员，我希望能为特定错误码配置自定义错误页面路径。
- 作为管理员，我希望能随时添加或删除错误码配置。

#### US-6: 访问限制（Limiters）
- 作为管理员，我希望能选择允许或拒绝某些IP或子网访问网关。
- 作为管理员，我希望输入IP或子网时能获得格式校验提示。
- 作为管理员，我希望能配置最大允许并发量和允许的每分钟call的数量，需要保障至少有一个相应的限制存在。
- 作为管理员，我希望能配置服务允许的请求方法。

#### US-7: 配置版本管理
- 作为管理员，我希望查看配置的变更历史和版本对比。
- 作为管理员，我希望能够一键回滚到历史版本。
- 作为管理员，我希望能够导入导出配置文件。

### 监控与可观测性用户故事

#### US-8: 实时监控
- 作为运维人员，我希望实时查看网关的流量、响应时间、错误率等关键指标。
- 作为运维人员，我希望能够按域名、路径、后端服务器等维度筛选监控数据。
- 作为运维人员，我希望能够自定义时间范围查询历史数据。

#### US-9: 告警管理
- 作为运维人员，我希望配置监控阈值，当指标超过阈值时自动告警。
- 作为运维人员，我希望能够选择多种通知方式（邮件、短信、Webhook等）。
- 作为运维人员，我希望查看告警历史和处理状态。

#### US-10: 日志分析
- 作为运维人员，我希望查看完整的请求/响应日志。
- 作为运维人员，我希望能够按IP、状态码、响应时间等条件搜索日志。
- 作为运维人员，我希望能够导出日志进行分析。

### 安全与防护用户故事

#### US-11: WAF配置
- 作为安全管理员，我希望配置SQL注入、XSS攻击检测规则。
- 作为安全管理员，我希望编写自定义安全规则。
- 作为安全管理员，我希望查看安全事件统计和攻击报告。

#### US-12: 限流与熔断
- 作为运维人员，我希望配置基于用户、IP、API路径的限流策略。
- 作为运维人员，我希望配置熔断器参数，防止服务雪崩。
- 作为运维人员，我希望监控限流和熔断的效果。

#### US-13: 认证授权
- 作为安全管理员，我希望配置JWT Token验证和OAuth2.0集成。
- 作为安全管理员，我希望管理API Key和用户会话。
- 作为安全管理员，我希望配置单点登录。

### 性能优化用户故事

#### US-14: 缓存管理
- 作为运维人员，我希望配置HTTP缓存头和缓存规则。
- 作为运维人员，我希望监控缓存命中率和优化缓存策略。
- 作为运维人员，我希望配置缓存失效和预加载策略。

#### US-15: 连接优化
- 作为运维人员，我希望配置请求压缩和静态资源CDN。
- 作为运维人员，我希望优化连接池和Keep-Alive配置。
- 作为运维人员，我希望监控连接性能指标。

### 运维管理用户故事

#### US-16: 运维工具
- 作为运维人员，我希望能够热重载配置和进行灰度发布。
- 作为运维人员，我希望能够重启、停止、扩容服务。
- 作为运维人员，我希望监控系统资源使用情况。

#### US-17: 问题诊断
- 作为运维人员，我希望使用分布式追踪分析请求链路。
- 作为运维人员，我希望获得性能瓶颈分析和优化建议。
- 作为运维人员，我希望自动诊断错误根因。

### 多租户与团队协作用户故事

#### US-18: 多租户管理
- 作为超级管理员，我希望管理多个租户和资源配额。
- 作为租户管理员，我希望管理本租户的配置和用户。
- 作为管理员，我希望查看计费和用量统计。

#### US-19: 团队协作
- 作为管理员，我希望管理用户角色和权限。
- 作为管理员，我希望查看操作审计日志。
- 作为团队成员，我希望使用知识库和协作工具。

### 通用用户故事

#### US-20: Tab分区交互
- 作为用户，我希望所有配置项分布在不同Tab下，避免页面滚动，提升填写体验。

#### US-21: 全局设置
- 当访问页面时，我希望先调用一个后台API，它提供了我所有上述选项的配置默认值和可用选项。
- 当访问页面时，我希望先调用一个后台API, 它会加载我当前页面所有标签和选项的多语言label，我的页面能根据右上角的语言选择来切换配置网页的显示文字。

---

## 用例（Use Cases）

### 配置管理用例
1. 管理员进入页面，前端自动调用API获取所有默认值、可用选项和多语言label。
2. 管理员在Basic Tab选择CMDB项目、填写域名、路径等，系统校验唯一性。
3. 管理员在Targets Tab添加多个目标服务器，配置负载均衡和健康检查。
4. 管理员在Cookies Tab配置转发策略和例外。
5. 管理员在Headers Tab配置请求和响应Header。
6. 管理员在Response Body Decorator Tab配置错误码页面。
7. 管理员在Limiters Tab配置IP限制、最大并发、每分钟调用数、请求方法，且至少有一项限制。
8. 管理员查看配置变更历史，必要时回滚到历史版本。

### 监控运维用例
1. 运维人员查看实时监控仪表板，了解网关运行状态。
2. 运维人员配置告警阈值和通知方式。
3. 运维人员分析日志，排查问题根因。
4. 运维人员使用诊断工具优化性能。

### 安全管理用例
1. 安全管理员配置WAF规则，防护常见攻击。
2. 安全管理员设置API限流和熔断策略。
3. 安全管理员管理认证授权和API Key。

### 团队协作用例
1. 管理员管理用户角色和权限。
2. 团队成员使用知识库和协作工具。
3. 管理员查看操作审计日志。

---

## 技术架构

### 前端技术栈
- React 18 + Next.js 14
- Material-UI (MUI) 组件库
- TypeScript 类型安全
- React Query 数据管理
- Recharts 图表展示
- React Hook Form 表单管理

### 后端技术栈
- Spring Boot 3.x
- Spring Security 安全框架
- Spring Data JPA 数据访问
- Redis 缓存和会话管理
- Elasticsearch 日志存储
- Prometheus + Grafana 监控

### 部署架构
- Docker 容器化部署
- Kubernetes 编排管理
- Nginx 反向代理
- MySQL/PostgreSQL 主数据库
- Redis 缓存数据库

---

## 其他说明
- 所有UI均采用MUI组件，风格统一现代。
- 所有表单项均需前端校验，确保数据有效性。
- 页面默认语言为英文，文档可用中文编辑。
- 支持响应式设计，适配桌面端和移动端。
- 提供完整的API文档和开发者指南。
- 支持多环境部署（开发、测试、生产）。
